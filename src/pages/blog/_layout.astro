---
import path from 'path'

import type { PostMetadata } from '../../env'
import Layout from '../../components/blog/Layout.astro'
import Post from '../../components/blog/Post.astro'
import Seo from '../../components/blog/Seo.astro'

export interface Props {
    file: string
    frontmatter: PostMetadata
}

const { frontmatter: metadata } = Astro.props

if (!(metadata.image?.startsWith('http') ?? true)) {
    // Obtain relative directory name: /[...]/blog/my-post/index.mdx -> my-post
    const post = path.basename(path.dirname(Astro.props.file))

    // Obtains the image file name without extension: ./header.png -> header
    const file = path.basename(metadata.image).replace(/\.\w*$/, '')

    // Obtains the image extension: ./header.png -> png
    const extension = path.extname(metadata.image).slice(1)

    // Little trick to allow Vite dynamic imports by statically separating
    // file name from extension for improved runtime validation.
    metadata.image = (await import (`./${post}/${file}.${extension}`)).default
}
---

<Layout>
    <Seo slot="meta" {...metadata} />

    <Post metadata={metadata}>
        <slot />
    </Post>
</Layout>